# API Gateway с NGINX

Этот каталог содержит конфигурацию NGINX, который используется в качестве API Gateway для проекта GameTrade.

## Общие сведения

API Gateway выполняет следующие функции:
- Маршрутизация запросов к соответствующим микросервисам
- Балансировка нагрузки
- Ограничение скорости запросов
- Терминация SSL
- Сжатие и буферизация
- Проверка состояния сервисов

## Структура директории

```
nginx/
├── conf.d/                # Директория с конфигурационными файлами
│   ├── default.conf       # Основная конфигурация для HTTP
│   └── ssl.conf           # Конфигурация для HTTPS
└── nginx.conf             # Главный конфигурационный файл
```

## Маршрутизация API

NGINX настроен для маршрутизации запросов к различным микросервисам по пути URL:

| Путь API            | Сервис              | Порт |
|---------------------|---------------------|------|
| `/api/auth/`        | auth-svc            | 8000 |
| `/api/marketplace/` | marketplace-svc     | 8001 |
| `/api/payments/`    | payment-svc         | 8002 |
| `/api/chat/`        | chat-svc            | 8003 |
| `/ws/`              | chat-svc (WebSocket)| 8003 |

## Ограничения скорости (Rate Limiting)

Для предотвращения DoS-атак и защиты от перегрузки, NGINX настроен с ограничением скорости запросов:

```nginx
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
```

Разные конечные точки имеют различные настройки пакетной обработки (burst):

| Конечная точка       | Burst | Комментарий                           |
|----------------------|-------|---------------------------------------|
| `/api/auth/`         | 20    | Стандартная авторизация               |
| `/api/marketplace/`  | 20    | Просмотр и поиск объявлений           |
| `/api/payments/`     | 5     | Ограниченная скорость для платежей    |
| `/api/chat/`         | 50    | Высокая пропускная способность для чата |

## SSL/TLS конфигурация

В продакшн-среде настроена поддержка SSL/TLS с оптимальными настройками безопасности:

- Поддержка только TLSv1.2 и TLSv1.3
- Оптимизированный набор шифров
- Настройки OCSP Stapling
- HTTP Strict Transport Security (HSTS)
- Автоматическое перенаправление с HTTP на HTTPS

## WebSocket конфигурация

Для чат-функциональности настроена поддержка WebSocket с оптимальными таймаутами:

```nginx
location /ws/ {
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_read_timeout 300s;
    proxy_connect_timeout 75s;
    proxy_send_timeout 300s;
}
```

## Мониторинг и проверка состояния

Реализована конечная точка для проверки состояния API Gateway:

```
GET /health
```

## Оптимизация производительности

- Сжатие gzip для различных типов контента
- Буферизация запросов и ответов
- Оптимизированные настройки воркеров и соединений
- Кэширование для статических файлов

## Настройка для разработки

В режиме разработки вы можете использовать NGINX через Docker Compose:

```bash
docker-compose up -d nginx
```

## Настройка для продакшна

Для продакшн-среды требуется:

1. Настроить реальные SSL-сертификаты (Let's Encrypt рекомендуется)
2. Изменить `server_name` на реальное доменное имя
3. Настроить логирование в соответствии с потребностями
4. Включить мониторинг NGINX через Prometheus или аналогичные инструменты

## Безопасность

API Gateway настроен с несколькими уровнями безопасности:

- Заголовки безопасности: X-Frame-Options, X-Content-Type-Options, X-XSS-Protection
- Ограничение скорости запросов (rate limiting)
- Отключение отображения версии NGINX (server_tokens off)
- Настройки SSL/TLS для максимальной безопасности

## Устранение неполадок

При проблемах с API Gateway, проверьте:

1. Логи NGINX: `/var/log/nginx/error.log` и `/var/log/nginx/access.log`
2. Проверьте доступность сервисов через конечную точку `/health`
3. Проверьте сетевую доступность между контейнерами Docker 