# Тесты для сервиса аутентификации (auth-svc)

## Структура тестов

Тесты разделены на следующие категории:

- **Модульные тесты (`unit`)**: тестируют отдельные модули и функции
- **Интеграционные тесты (`integration`)**: тестируют взаимодействие между компонентами
- **Тесты API (`api`)**: тестируют API конечные точки

## Основные тестовые файлы

- `conftest.py` - общие фикстуры для тестов
- `test_password.py` - тесты для сервиса паролей
- `test_jwt.py` - тесты для сервиса JWT токенов
- `test_auth_api.py` - тесты для API аутентификации
- `test_register_api.py` - тесты для API регистрации
- `test_account_api.py` - тесты для API управления аккаунтом
- `test_roles_api.py` - тесты для API управления ролями и разрешениями
- `test_authorization.py` - тесты для системы авторизации
- `test_rate_limiter.py` - тесты для сервиса ограничения частоты запросов
- `test_email.py` - тесты для сервиса отправки электронной почты
- `test_client_auth.py` - тесты для сервиса клиентской аутентификации
- `test_auth_middleware.py` - тесты для middleware аутентификации
- `test_roles.py` - тесты для сервиса ролей и разрешений

## Запуск тестов

Для удобства запуска тестов создан скрипт `scripts/run_tests.sh`. Для запуска всех тестов выполните:

```bash
# Убедитесь, что скрипт имеет права на выполнение
chmod +x scripts/run_tests.sh

# Запуск всех тестов
./scripts/run_tests.sh
```

### Параметры запуска

Скрипт поддерживает следующие параметры:

- `-h, --help` - показать справку
- `-v, --verbose` - подробный вывод при выполнении тестов
- `-c, --coverage` - запустить с отчетом о покрытии кода
- `-r, --report` - создать HTML-отчет
- `-u, --unit` - запустить только модульные тесты
- `-i, --integration` - запустить только интеграционные тесты
- `-a, --api` - запустить только тесты API
- `-k, --keyword KEYWORD` - запустить только тесты, содержащие указанное ключевое слово
- `-x, --xvs` - остановить выполнение при первой ошибке

Примеры:

```bash
# Запустить только модульные тесты
./scripts/run_tests.sh -u

# Запустить тесты с отчетом о покрытии и HTML-отчетом
./scripts/run_tests.sh -c -r

# Запустить тесты, связанные с паролями
./scripts/run_tests.sh -k password

# Запустить быстрые тесты аутентификации
./scripts/run_tests.sh -k 'auth and not slow'
```

## Установка зависимостей для тестирования

Для установки всех зависимостей, необходимых для тестирования, выполните:

```bash
pip install -r requirements-dev.txt
```

## Метки (markers)

Для организации тестов используются следующие метки:

- `unit` - модульные тесты
- `integration` - интеграционные тесты
- `api` - тесты API
- `slow` - медленные тесты
- `auth` - тесты аутентификации
- `roles` - тесты ролей и разрешений
- `password` - тесты сервиса паролей
- `jwt` - тесты сервиса JWT токенов
- `email` - тесты сервиса электронной почты
- `rate_limit` - тесты ограничения частоты запросов
- `middleware` - тесты middleware

Метки можно использовать для выборочного запуска тестов:

```bash
# Через скрипт
./scripts/run_tests.sh -k "jwt"

# Напрямую через pytest
pytest -m "jwt"
```

## Фикстуры

Основные фикстуры, доступные для тестов:

- `test_db` - тестовая база данных в памяти
- `client` - тестовый клиент FastAPI
- `test_user` - тестовый пользователь
- `test_admin` - тестовый пользователь с правами администратора
- `user_token` - токены для обычного пользователя
- `admin_token` - токены для администратора

## Добавление новых тестов

При добавлении новых тестов рекомендуется соблюдать следующие принципы:

1. Размещайте тесты в соответствующих файлах по категориям
2. Используйте соответствующие метки для классификации тестов
3. Используйте моки для изоляции тестов от внешних зависимостей
4. Пишите отдельные тесты для позитивных и негативных сценариев
5. Следуйте соглашению об именовании: `test_<что_тестируем>_<сценарий>` 