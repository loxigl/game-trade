# Документация сервиса аутентификации (auth-svc)

## 1. Общее описание

Сервис аутентификации (auth-svc) отвечает за управление учетными записями пользователей, аутентификацию, авторизацию и управление ролями/разрешениями в системе GameTrade. Это является критически важным компонентом для обеспечения безопасности всей платформы.

## 2. Архитектура

Auth-svc реализован как независимый микросервис на основе FastAPI (Python) с собственной базой данных PostgreSQL и использованием Redis для хранения черного списка токенов и управления сессиями.

### 2.1. Основные компоненты:

- **API слой** (routes): Реализует REST API для взаимодействия с другими сервисами и клиентами
- **Бизнес-логика** (services): Содержит основную логику аутентификации, авторизации и управления пользователями
- **Слой данных** (models): Описывает структуру данных и взаимодействие с базой данных
- **Схемы** (schemas): Определяет форматы запросов/ответов API
- **Конфигурация** (config): Содержит настройки сервиса

### 2.2. Зависимости:

- PostgreSQL - хранение данных пользователей
- Redis - хранение черного списка токенов и управление сессиями
- RabbitMQ - для асинхронного взаимодействия с другими сервисами

## 3. Модель данных

### 3.1. Основные сущности:

#### 3.1.1. Пользователь (User)

```
- id: Integer (PK)
- username: String (unique)
- email: String (unique)
- hashed_password: String
- is_active: Boolean
- is_verified: Boolean
- is_admin: Boolean
- created_at: DateTime
- updated_at: DateTime
- roles: Array[String]
- last_password_change: DateTime
- failed_login_attempts: Integer
- account_locked_until: DateTime
- password_reset_token: String
- password_reset_expires: DateTime
```

#### 3.1.2. Схемы данных

- **UserBase**: Базовые поля пользователя (username, email)
- **UserCreate**: Схема для создания пользователя (+ password)
- **UserLogin**: Схема для входа в систему (username/email + password)
- **UserResponse**: Схема для ответа с данными пользователя
- **UserUpdate**: Схема для обновления пользователя
- **Token**: Схема для JWT токенов
- **TokenData**: Схема для полезной нагрузки JWT токена
- **TokenValidateRequest/Response**: Схемы для валидации токенов

## 4. API

### 4.1. Группы маршрутов:

1. **auth** - Операции аутентификации и управления токенами
2. **register** - Регистрация и подтверждение аккаунтов
3. **account** - Управление профилем и настройками пользователя
4. **roles** - Управление ролями пользователей
5. **permissions** - Управление и проверка разрешений

### 4.2. Основные эндпоинты:

#### 4.2.1. Аутентификация (/auth):

- **POST /login** - Аутентификация пользователя и выдача JWT токенов
- **POST /refresh** - Обновление токенов доступа
- **POST /logout** - Выход из системы (добавление токенов в черный список)
- **POST /validate** - Проверка валидности токена

#### 4.2.2. Регистрация (/register):

- **POST /** - Регистрация нового пользователя
- **POST /verify** - Подтверждение электронной почты
- **POST /resend-verification** - Повторная отправка кода подтверждения

#### 4.2.3. Управление аккаунтом (/account):

- **GET /** - Получение информации о своём аккаунте
- **PUT /** - Обновление данных аккаунта
- **POST /change-password** - Изменение пароля
- **POST /request-password-reset** - Запрос сброса пароля
- **POST /reset-password** - Сброс пароля

#### 4.2.4. Управление ролями (/roles):

- **GET /** - Получение списка всех ролей
- **POST /** - Создание новой роли
- **PUT /{role_id}** - Обновление роли
- **DELETE /{role_id}** - Удаление роли
- **POST /assign** - Назначение роли пользователю
- **POST /revoke** - Отзыв роли у пользователя

#### 4.2.5. Управление разрешениями (/permissions):

- **GET /** - Получение списка всех разрешений
- **POST /check** - Проверка наличия разрешения у пользователя

## 5. Сервисы (Бизнес-логика)

### 5.1. Основные сервисы:

- **auth_middleware** - Middleware для аутентификации запросов
- **authorization** - Проверка прав доступа
- **client_auth** - Аутентификация клиентов (OAuth)
- **email** - Отправка электронных писем
- **jwt** - Работа с JWT токенами
- **password** - Хеширование и проверка паролей
- **rabbitmq_service** - Взаимодействие с RabbitMQ
- **rate_limiter** - Ограничение частоты запросов
- **roles** - Управление ролями пользователей
- **user_event_service** - События, связанные с пользователями

### 5.2. Ключевые функции JWT сервиса:

- **create_access_token** - Создание токена доступа
- **create_refresh_token** - Создание refresh токена
- **verify_token** - Проверка валидности токена
- **is_token_blacklisted** - Проверка токена в черном списке
- **blacklist_token** - Добавление токена в черный список
- **refresh_tokens** - Обновление пары токенов
- **decode_token** - Декодирование JWT токена

## 6. Конфигурация

Основные настройки сервиса определены в `settings.py`:

- **APP_NAME** - Название приложения
- **DATABASE_URL** - URL подключения к PostgreSQL
- **REDIS_URL** - URL подключения к Redis
- **JWT_SECRET** - Секретный ключ для JWT токенов
- **JWT_ALGORITHM** - Алгоритм шифрования JWT (HS256)
- **JWT_EXPIRE_MINUTES** - Время жизни JWT токенов (24 часа)

## 7. Интеграция с другими сервисами

Сервис аутентификации взаимодействует с другими сервисами через:

1. **Синхронное API** - Для проверки токенов и получения информации о пользователях
2. **Асинхронные события через RabbitMQ** - Для уведомления других сервисов о создании/изменении/удалении пользователей

## 8. Механизмы безопасности

- JWT токены с ограниченным сроком действия
- Хранение паролей в хешированном виде (bcrypt)
- Черный список отозванных токенов
- Ограничение частоты запросов (rate limiting)
- Защита от блокировки аккаунта при множественных неудачных попытках входа
- Проверка надежности паролей

## 9. Обработка ошибок

- Стандартизированные HTTP ответы с соответствующими статус-кодами
- Подробные сообщения об ошибках
- Логирование ошибок для отладки

## 10. Расширяемость

Сервис спроектирован с учетом будущих расширений:
- Модульная структура для добавления новых функций
- Поддержка различных методов аутентификации
- Гибкая система ролей и разрешений 