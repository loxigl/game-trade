# Payment Service (payment-svc)

Микросервис для управления платежами, транзакциями и кошельками пользователей маркетплейса.

## Функциональные возможности

### Управление транзакциями
- Создание транзакций
- Перевод средств в Escrow
- Завершение транзакций (выплата продавцу)
- Возврат средств покупателю
- Создание и разрешение споров
- Отмена транзакций
- Контроль за статусами и жизненным циклом транзакций

### Система Escrow
- Безопасная промежуточная задержка средств
- Защита покупателя и продавца при совершении сделок
- Поддержка различных сценариев разрешения споров

### Кошельки пользователей
- Создание и управление кошельками
- Поддержка различных валют
- Операции пополнения и вывода средств
- Ведение истории операций

## Архитектура

### Модель данных
- **Transaction**: основная модель транзакций с поддержкой различных статусов (PENDING, ESCROW_HELD, COMPLETED, REFUNDED, DISPUTED, RESOLVED, CANCELED)
- **Wallet**: модель кошелька пользователя
- **WalletTransaction**: модель для отслеживания операций с кошельком

### Система состояний
- **TransactionStateMachine**: машина состояний для управления жизненным циклом транзакций
- **TransactionStateService**: сервис для управления переходами между состояниями транзакций
- **TransactionTimeoutService**: сервис для обработки истекших транзакций

### Система событий
- **EventService**: служба для публикации и обработки внутренних событий
- **EventRabbitBridge**: мост для трансляции событий в RabbitMQ

### Идемпотентность
- **IdempotencyService**: сервис для обеспечения идемпотентности операций
- **IdempotencyRecord**: модель для хранения записей идемпотентности
- **IdempotencyCleanupService**: сервис для периодической очистки устаревших записей

## API Endpoints

### Транзакции
- `POST /transactions` - Создание новой транзакции
- `GET /transactions` - Получение списка транзакций
- `GET /transactions/{id}` - Получение информации о транзакции
- `GET /transactions/{id}/actions` - Получение доступных действий
- `POST /transactions/{id}/escrow` - Перевод средств в Escrow
- `POST /transactions/{id}/complete` - Завершение транзакции
- `POST /transactions/{id}/refund` - Возврат средств
- `POST /transactions/{id}/dispute` - Открытие спора
- `POST /transactions/{id}/resolve` - Разрешение спора
- `POST /transactions/{id}/cancel` - Отмена транзакции

### Кошельки
- `GET /wallets` - Получение списка кошельков пользователя
- `GET /wallets/{id}` - Получение информации о кошельке
- `POST /wallets` - Создание нового кошелька
- `POST /wallets/{id}/deposit` - Пополнение кошелька
- `POST /wallets/{id}/withdraw` - Вывод средств

## Интеграции

### RabbitMQ
- Публикация событий для других микросервисов
- Обработка событий от других микросервисов

## Безопасность
- Проверка прав доступа для всех операций
- Идемпотентность операций через заголовок X-Idempotency-Key
- Логирование всех операций для аудита

## Развертывание
Сервис разворачивается как отдельный контейнер и взаимодействует с другими микросервисами через RabbitMQ и HTTP API.

## Переменные окружения
- `DATABASE_URL` - URL для подключения к базе данных
- `RABBITMQ_URL` - URL для подключения к RabbitMQ
- `SERVICE_PORT` - Порт для запуска сервиса (по умолчанию 8080)
- `LOG_LEVEL` - Уровень логирования
- `JWT_SECRET` - Секрет для проверки JWT токенов 