# Документация сервиса платежей (payment-svc)

## 1. Общее описание

Сервис платежей (payment-svc) является ключевым компонентом платформы GameTrade, отвечающим за управление финансовыми операциями. Сервис обеспечивает функциональность для работы с кошельками пользователей, обработки транзакций, включая покупки, пополнения и выводы средств, работы с эскроу-счетами, а также сбора статистики и генерации отчетов.

## 2. Архитектура

Payment-svc разработан как независимый микросервис на основе FastAPI (Python) с собственной базой данных PostgreSQL. Сервис интегрируется с другими компонентами системы через REST API и асинхронный обмен сообщениями через RabbitMQ.

### 2.1. Основные компоненты:

- **API слой** (routers): Реализует REST API эндпоинты для выполнения различных финансовых операций
- **Бизнес-логика** (services): Содержит реализацию бизнес-логики обработки транзакций и управления кошельками
- **Слой данных** (models): Определяет структуру данных и взаимодействие с базой данных
- **Схемы** (schemas): Определяет форматы запросов/ответов API
- **Инфраструктура** (dependencies, database): Общие компоненты для работы сервиса

### 2.2. Зависимости:

- PostgreSQL - хранение данных о кошельках, транзакциях и связанной информации
- RabbitMQ - для асинхронного взаимодействия с другими сервисами
- Redis - для управления идемпотентностью и временными данными

## 3. Модель данных

### 3.1. Основные сущности:

#### 3.1.1. Кошелек (Wallet)

```
- id: Integer (PK)
- wallet_uid: String (unique)
- user_id: Integer (FK -> users.id)
- balances: JSON ({"USD": 1000.0, "EUR": 750.0, ...})
- status: Enum (ACTIVE, BLOCKED, PENDING, CLOSED)
- is_default: Boolean
- is_system_escrow: Boolean
- is_system_fee: Boolean
- limits: JSON ({"USD": {"daily": 10000.0, "monthly": 50000.0}, ...})
- created_at: DateTime
- updated_at: DateTime
- last_activity_at: DateTime
- notes: Text
```

#### 3.1.2. Транзакция (Transaction)

```
- id: Integer (PK)
- transaction_uid: String (unique)
- buyer_id: Integer (FK -> users.id)
- seller_id: Integer (FK -> users.id)
- listing_id: Integer
- item_id: Integer
- amount: Float
- currency: String
- fee_amount: Float
- fee_percentage: Float
- status: Enum (PENDING, ESCROW_HELD, COMPLETED, REFUNDED, DISPUTED, CANCELED, FAILED)
- type: Enum (PURCHASE, DEPOSIT, WITHDRAWAL, REFUND, FEE, SYSTEM)
- created_at: DateTime
- updated_at: DateTime
- completed_at: DateTime
- expiration_date: DateTime
- escrow_held_at: DateTime
- disputed_at: DateTime
- refunded_at: DateTime
- canceled_at: DateTime
- description: Text
- notes: Text
- extra_data: JSON
- external_reference: String
- dispute_reason: Text
- refund_reason: Text
- cancel_reason: Text
- wallet_id: Integer (FK -> wallets.id)
- parent_transaction_id: Integer (FK -> transactions.id)
```

#### 3.1.3. Запись транзакции кошелька (WalletTransaction)

```
- id: Integer (PK)
- wallet_id: Integer (FK -> wallets.id)
- transaction_id: Integer (FK -> transactions.id)
- amount: Float
- currency: Enum (USD, EUR, GBP, RUB, JPY, CNY)
- balance_before: Float
- balance_after: Float
- type: String (credit, debit)
- description: Text
- extra_data: JSON
- created_at: DateTime
```

## 4. API

### 4.1. Группы маршрутов:

1. **wallets** - Операции с кошельками и балансами
2. **transactions** - Управление транзакциями
3. **transaction_history** - История транзакций и экспорт данных
4. **currency** - Операции с валютами и курсами обмена
5. **statistics** - Статистика и отчеты по транзакциям
6. **sales** - Управление продажами маркетплейса

### 4.2. Основные эндпоинты:

#### 4.2.1. Управление кошельками (/wallets):

- **GET /** - Получение списка кошельков пользователя
- **GET /{wallet_id}** - Получение информации о конкретном кошельке
- **POST /** - Создание нового кошелька
- **PUT /{wallet_id}** - Обновление информации о кошельке
- **GET /{wallet_id}/balance** - Получение баланса кошелька
- **POST /{wallet_id}/deposit** - Пополнение кошелька
- **POST /{wallet_id}/withdraw** - Вывод средств с кошелька

#### 4.2.2. Управление транзакциями (/transactions):

- **GET /** - Получение списка транзакций пользователя
- **GET /{transaction_id}** - Получение информации о конкретной транзакции
- **POST /** - Создание новой транзакции
- **POST /{transaction_id}/confirm** - Подтверждение транзакции
- **POST /{transaction_id}/cancel** - Отмена транзакции
- **POST /{transaction_id}/dispute** - Создание спора по транзакции
- **POST /{transaction_id}/refund** - Возврат средств по транзакции

#### 4.2.3. История транзакций (/transaction_history):

- **GET /** - Получение истории транзакций с фильтрацией
- **GET /report** - Генерация отчета о транзакциях
- **GET /export** - Экспорт истории транзакций в различных форматах

#### 4.2.4. Валюты и курсы обмена (/currency):

- **GET /** - Получение списка поддерживаемых валют
- **GET /rates** - Получение актуальных курсов обмена
- **POST /convert** - Конвертация сумм между валютами

#### 4.2.5. Статистика (/statistics):

- **GET /user/{user_id}** - Получение статистики по пользователю
- **GET /monthly** - Получение ежемесячной статистики
- **GET /daily** - Получение ежедневной статистики
- **GET /sales** - Статистика по продажам

#### 4.2.6. Управление продажами (/sales):

- **GET /** - Получение списка продаж
- **GET /{sale_id}** - Получение информации о конкретной продаже
- **POST /{sale_id}/complete** - Завершение продажи (перевод средств с эскроу на кошелек продавца)
- **POST /{sale_id}/refund** - Возврат средств покупателю

## 5. Сервисы (Бизнес-логика)

### 5.1. Основные сервисы:

- **transaction_service** - Обработка различных типов транзакций
- **wallet_service** - Управление кошельками и балансами
- **escrow_service** - Управление эскроу-счетами для безопасных сделок
- **currency_service** - Работа с валютами и конвертацией
- **transaction_timeout_service** - Отслеживание и обработка транзакций с истекшим сроком действия
- **idempotency_cleanup_service** - Очистка устаревших ключей идемпотентности
- **message_handler** - Обработка входящих сообщений из RabbitMQ
- **rabbitmq_service** - Взаимодействие с RabbitMQ
- **user_consumer_service** - Обработка событий, связанных с пользователями

## 6. Обработка транзакций

### 6.1. Жизненный цикл транзакции:

1. **Создание** - Инициализация транзакции с типом и суммой
2. **Проверка** - Валидация достаточности средств и прав
3. **Блокировка средств** - Средства блокируются на счете (для эскроу)
4. **Подтверждение/Отмена** - Завершение или отмена транзакции
5. **Финализация** - Перевод средств или возврат на исходный счет

### 6.2. Типы транзакций:

- **PURCHASE** - Покупка товара/услуги
- **DEPOSIT** - Пополнение кошелька
- **WITHDRAWAL** - Вывод средств с кошелька
- **REFUND** - Возврат средств
- **FEE** - Комиссия платформы
- **SYSTEM** - Системная операция

### 6.3. Статусы транзакций:

- **PENDING** - Ожидает оплаты/обработки
- **ESCROW_HELD** - Средства в Escrow
- **COMPLETED** - Успешно завершена
- **REFUNDED** - Средства возвращены
- **DISPUTED** - В процессе разрешения спора
- **CANCELED** - Отменена
- **FAILED** - Не удалось обработать

## 7. Интеграция с другими сервисами

Сервис платежей взаимодействует с другими сервисами через:

1. **Синхронные API запросы** - Для проверки данных пользователей через auth-svc и получения данных о товарах через marketplace-svc
2. **Асинхронные события через RabbitMQ** - Для уведомления других сервисов о транзакциях и обновления соответствующих данных

### 7.1. События, отправляемые в RabbitMQ:

- **transaction.created** - При создании новой транзакции
- **transaction.completed** - При успешном завершении транзакции
- **transaction.refunded** - При оформлении возврата
- **transaction.disputed** - При создании спора
- **transaction.canceled** - При отмене транзакции
- **wallet.updated** - При изменении баланса кошелька

### 7.2. События, получаемые из RabbitMQ:

- **user.created** - Создание кошелька для нового пользователя
- **user.deleted** - Блокировка кошелька удаленного пользователя
- **listing.created** - Для создания связанных эскроу-записей
- **listing.sold** - Для инициации процесса перевода средств с эскроу

## 8. Безопасность и надежность

### 8.1. Механизмы безопасности:

- Проверка JWT токенов для аутентификации и авторизации
- Изоляция транзакций для обеспечения согласованности данных
- Журналирование всех финансовых операций
- Двойная проверка прав доступа перед выполнением транзакций
- Эскроу для защиты покупателей и продавцов

### 8.2. Обеспечение надежности:

- Идемпотентность операций для предотвращения дублирования транзакций
- Автоматическая обработка тайм-аутов транзакций
- Мониторинг состояния транзакций и уведомление о проблемах
- Механизм возврата системы в стабильное состояние после сбоев

## 9. Обработка ошибок

- Стандартизированные HTTP ответы с соответствующими статус-кодами
- Специализированные типы ошибок для разных категорий проблем
- Детальное логирование ошибок для облегчения отладки
- Механизмы повторных попыток для транзиентных ошибок

## 10. Расширяемость и масштабируемость

- Модульная структура для добавления новых типов транзакций
- Поддержка мультивалютности для международных операций
- Механизмы обработки возрастающей нагрузки
- Распределенная архитектура с возможностью горизонтального масштабирования 