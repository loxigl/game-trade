# API Документация платежной системы

## Общая информация

API платежной системы предоставляет следующие основные функциональные возможности:
- Управление кошельками и балансами
- Операции с транзакциями
- Конвертация валют
- Управление продажами
- Статистика и отчеты
- История транзакций

## Аутентификация

Все запросы к API должны содержать заголовок `Authorization` с JWT токеном:
```
Authorization: Bearer <token>
```

## Основные эндпоинты

### Кошельки (`/wallets`)

#### Создание кошелька
```http
POST /wallets
```
Создает новый кошелек для пользователя.

**Параметры запроса:**
- `wallet_data` (тело запроса):
  - `user_id` (int): ID пользователя
  - `currency` (string): Валюта кошелька (USD, EUR, RUB)
  - `status` (string): Статус кошелька (active, blocked)

**Ответ:**
```json
{
  "id": 1,
  "user_id": 123,
  "currency": "USD",
  "balance": "0.00",
  "status": "active",
  "created_at": "2024-03-20T10:00:00Z"
}
```

#### Получение списка кошельков
```http
GET /wallets
```
Возвращает список кошельков с пагинацией и фильтрацией.

**Параметры запроса:**
- `page` (int, query): Номер страницы (по умолчанию 1)
- `size` (int, query): Размер страницы (по умолчанию 20, макс. 100)
- `user_id` (int, query, опционально): Фильтр по ID пользователя
- `status` (string, query, опционально): Фильтр по статусу

**Ответ:**
```json
{
  "total": 100,
  "items": [...],
  "page": 1,
  "size": 20,
  "pages": 5
}
```

#### Получение кошелька по ID
```http
GET /wallets/{wallet_id}
```
Возвращает информацию о конкретном кошельке.

**Параметры пути:**
- `wallet_id` (int): ID кошелька

#### Получение кошелька по UID
```http
GET /wallets/by-uid/{wallet_uid}
```
Возвращает информацию о кошельке по его уникальному идентификатору.

**Параметры пути:**
- `wallet_uid` (string): Уникальный идентификатор кошелька

#### Получение кошелька пользователя
```http
GET /wallets/user/{user_id}
```
Возвращает кошелек конкретного пользователя.

**Параметры пути:**
- `user_id` (int): ID пользователя

#### Получение транзакций кошелька
```http
GET /wallets/{wallet_id}/transactions
```
Возвращает историю транзакций кошелька.

**Параметры запроса:**
- `wallet_id` (int, path): ID кошелька
- `page` (int, query): Номер страницы
- `size` (int, query): Размер страницы
- `currency` (string, query, опционально): Фильтр по валюте

#### Конвертация валюты
```http
POST /wallets/{wallet_id}/convert
```
Конвертирует валюту внутри кошелька.

**Параметры запроса:**
- `wallet_id` (int, path): ID кошелька
- `conversion_data` (тело запроса):
  - `wallet_id` (int): ID кошелька
  - `from_currency` (string): Исходная валюта
  - `to_currency` (string): Целевая валюта
  - `amount` (decimal): Сумма для конвертации

### Транзакции (`/transactions`)

#### Создание транзакции
```http
POST /transactions
```
Создает новую транзакцию.

**Параметры запроса:**
- `transaction_data` (тело запроса):
  - `type` (string): Тип транзакции
  - `amount` (decimal): Сумма
  - `currency` (string): Валюта
  - `description` (string): Описание
  - `metadata` (object): Дополнительные данные

#### Получение транзакции
```http
GET /transactions/{transaction_id}
```
Возвращает информацию о конкретной транзакции.

**Параметры пути:**
- `transaction_id` (int): ID транзакции

#### Получение списка транзакций
```http
GET /transactions
```
Возвращает список транзакций с фильтрацией.

**Параметры запроса:**
- `user_id` (int, query, опционально): Фильтр по ID пользователя
- `status` (string, query, опционально): Фильтр по статусу
- `page` (int, query): Номер страницы
- `page_size` (int, query): Размер страницы

#### Получение доступных действий
```http
GET /transactions/{transaction_id}/actions
```
Возвращает список доступных действий для транзакции.

**Параметры пути:**
- `transaction_id` (int): ID транзакции

### История транзакций (`/transactions/history`)

#### Получение истории транзакций
```http
GET /transactions/history
```
Возвращает историю транзакций с фильтрацией.

**Параметры запроса:**
- `user_id` (int, query, опционально): Фильтр по ID пользователя
- `status` (string, query, опционально): Фильтр по статусу
- `start_date` (datetime, query, опционально): Начальная дата
- `end_date` (datetime, query, опционально): Конечная дата
- `page` (int, query): Номер страницы
- `page_size` (int, query): Размер страницы

#### Получение истории конкретной транзакции
```http
GET /transactions/history/{transaction_id}
```
Возвращает историю изменений конкретной транзакции.

**Параметры пути:**
- `transaction_id` (int): ID транзакции

#### Экспорт истории транзакции
```http
GET /transactions/history/{transaction_id}/export
```
Экспортирует историю транзакции в CSV или JSON формате.

**Параметры запроса:**
- `transaction_id` (int, path): ID транзакции
- `format` (string, query): Формат экспорта (csv, json)

### Валюта (`/currency`)

#### Получение курсов валют
```http
GET /currency/rates
```
Возвращает текущие курсы валют.

**Параметры запроса:**
- `base_currency` (string, query): Базовая валюта (по умолчанию USD)
- `force_refresh` (boolean, query): Принудительное обновление курсов

#### Получение информации о комиссиях
```http
GET /currency/fees
```
Возвращает информацию о текущих комиссиях системы.

### Статистика (`/statistics`)

#### Получение статистики продавца
```http
GET /statistics/seller
```
Возвращает статистику по продажам.

**Параметры запроса:**
- `seller_id` (int, query, опционально): ID продавца
- `period` (string, query): Период статистики (week, month, quarter, year, all)
- `start_date` (datetime, query, опционально): Начальная дата
- `end_date` (datetime, query, опционально): Конечная дата

#### Получение сводки по транзакциям
```http
GET /statistics/transactions/summary
```
Возвращает сводку по транзакциям с группировкой.

**Параметры запроса:**
- `seller_id` (int, query, опционально): ID продавца
- `group_by` (string, query): Параметр группировки (month, game, status, type)
- `period` (string, query): Период статистики
- `start_date` (datetime, query, опционально): Начальная дата
- `end_date` (datetime, query, опционально): Конечная дата

## Коды ответов

- `200 OK`: Успешный запрос
- `201 Created`: Ресурс успешно создан
- `400 Bad Request`: Неверный запрос
- `401 Unauthorized`: Требуется аутентификация
- `403 Forbidden`: Нет прав доступа
- `404 Not Found`: Ресурс не найден
- `500 Internal Server Error`: Внутренняя ошибка сервера

## Обработка ошибок

Все ошибки возвращаются в формате:
```json
{
  "detail": "Описание ошибки"
}
```

## Идемпотентность

Для предотвращения дублирования операций используется заголовок `X-Idempotency-Key`. При повторном запросе с тем же ключом будет возвращен результат первой операции.

## Ограничения

- Максимальный размер страницы: 100 записей
- Минимальный размер страницы: 1 запись
- Максимальная длина описания транзакции: 1000 символов
- Минимальная сумма транзакции: 0.01
- Поддерживаемые валюты: USD, EUR, RUB 